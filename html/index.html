<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Interface</title>
  <script src="https://cdn.tailwindcss.com/3.4.3"></script>
</head>
<body class="bg-zinc-100 dark:bg-zinc-900">

  <div class="flex flex-col md:flex-row h-screen">
    
    <div class="md:flex-none md:w-48 bg-white dark:bg-zinc-800 shadow-md p-4 space-y-4" id="sidebar">
      <div class="flex justify-between items-center md:block">
        <div class="text-lg font-semibold text-zinc-800 dark:text-zinc-200" id="sidebar-title">Menu</div>
        <button class="md:hidden p-2 bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200 rounded-md focus:outline-none"
          id="sidebar-toggle">
          â˜°
        </button>
      </div>
      
      <!--    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <!-- dont remove this comment here -->
    <div class="">
     <ul class="space-y-2 mt-4 md:mt-0 hidden md:block" id="sidebar-menu">
        <li><a href="#"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-home-link">Home</a></li>
        <li><a href="#"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-profile-link">Profile</a></li>
        <li><a href="#"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-settings-link">Settings</a></li>
        <li><a href="#"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-logout-link">Logout</a></li>
      </ul>
     </div> 
    </div>

    <div class="flex flex-col flex-1" id="main-content">
      
      <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div class="flex-none p-4 bg-white dark:bg-zinc-800 shadow-md flex flex-col md:flex-row items-end md:items-end space-x-2"
id="chat-input-area">
<div class="flex-grow relative flex items-center" id="message-input-container">
 
  <button id="microphone-btn"
    class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    aria-label="Speak">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" fill="none"
      viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3m0 0A3 3 0 0111 4m6 0a6 6 0 016 6" />
    </svg>
  </button>
  
  <div class="relative w-full" id="message-input-wrapper">
   
    <textarea style="min-height:87px" id="message-box" placeholder="Type a message..."
      class="w-full p-2 border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-zinc-700 dark:border-zinc-600 dark:placeholder-zinc-400 dark:text-white pr-12 text-lg resize-none overflow-hidden"></textarea>
      
    <label
      class="absolute right-2 bottom-2 p-2 bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-white rounded-md shadow-md cursor-pointer hover:bg-zinc-300 dark:hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center space-x-2"
      id="file-upload-label">
      <input type="file" class="hidden" id="file-upload-input" />
      <img aria-hidden="true" alt="upload" src="https://placehold.co/20x20?text=ðŸ“¤" />
    </label>
    
  </div>
</div>        


<div class="flex flex-col w-full md:w-auto mt-2 md:mt-0 space-y-2 md:space-y-0" id="chat-options">
  
  <select
    class="p-2 border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-zinc-700 dark:border-zinc-600 dark:text-white text-lg w-full md:w-auto"
    id="model-select">
    <option value="routers/groq/groq.php?model=mixtral-8x7b-32768">R32-M</option>
    <option value="experts/general/general.php?model=mistralai/mixtral-8x22b-instruct">R32-L</option>
    <option value="experts/general/general.php?model=openai/gpt-4o-2024-05-13">GPT-4o</option>
    <option value="experts/general/general.php?model=google/gemini-flash-1.5">Gemini-F</option>
    <option value="experts/general/general.php?model=perplexity/llama-3-sonar-large-32k-online">Perplexity</option>
    <option value="experts/general/general.php?model=anthropic/claude-3.5-sonnet">Claude-3.5</option>    
  </select>
  
  <button style="margin-top:7px"
    class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg w-full md:w-auto"
    id="run-button" onclick="run_message(document.getElementById('message-box').value);document.getElementById('message-box').value='';">RUN</button>
    
</div>
</div>

<script> 
const messageBox = document.getElementById('message-box');

// Automatically adjust input box height
messageBox.addEventListener('input', () => {
  console.log("?");
  messageBox.style.height = 'auto';
  let h = messageBox.scrollHeight;
  if(h>400)h=400;
  messageBox.style.height = h + 'px';
  
  
});

// Ctrl+Enter = RUN
document.addEventListener('keydown', function(event) {
  if (event.key === 'Enter' && event.ctrlKey) {
    console.log('Ctrl+Enter pressed');
        run_message(document.getElementById('message-box').value);
  }
});


</script>

<!-- end of file -->


 
      <!--    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <!-- dont remove this comment here -->
    
    <a href="#" id="more-options-link" class="block text-blue-500 dark:text-blue-300 mt-2 ml-4">More options >></a>
      <div id="more-options" class="hidden mt-2 space-y-2 ml-4">
        <label class="flex items-center space-x-2" id="option1-label">
          <input type="checkbox" class="form-checkbox text-blue-500 dark:text-blue-300" id="option1-checkbox" />
          <span class="text-zinc-800 dark:text-zinc-200">Option 1</span>
        </label>
        <label class="flex items-center space-x-2" id="option2-label">
          <input type="checkbox" class="form-checkbox text-blue-500 dark:text-blue-300" id="option2-checkbox" />
          <span class="text-zinc-800 dark:text-zinc-200">Option 2</span>
        </label>
        <label class="flex items-center space-x-2" id="option3-label">
          <input type="checkbox" class="form-checkbox text-blue-500 dark:text-blue-300" id="option3-checkbox" />
          <span class="text-zinc-800 dark:text-zinc-200">Option 3</span>
        </label>
      </div>
      
    <script>
    document.getElementById('more-options-link').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('more-options').classList.toggle('hidden');
    });
    </script> 
  


      <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages-area">


        <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md text-lg" id="initial-message">
          <p class="text-zinc-800 dark:text-zinc-200">Hello! How can I assist you today?</p>
        </div>


        <div> 
          <div class="bg-blue-500 text-white p-4 rounded-lg shadow-md self-end text-lg " id="user-message">
            <p>What is robot32-chat and what can I do with it.</p>
          </div>

          <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" id="gpt-message">  
            <img src="/welcome2.jpg" width="200" height="200" alt="generated image"
              class="rounded-md shadow-md cursor-pointer" id="gpt-image-0" />
              <pre style = "white-space: pre-wrap" ><p class="text-zinc-800 dark:text-zinc-200">Robot32-chat is large language model based on open source LLM. 
Type in your question (or picture idea) and hit the RUN button.
You can try:
  What is the capital of Sweden?
  What is the smallest whale?
  Make me pythonc function that sorts custom objects be given param.
  A serene forest landscape at sunset, glassy lake reflecting the sky.
  A surreal, dreamlike landscape with floating islands.
          
Image generation is based on open source model Stable Diffusion Turbo (v1.5/XL)
            </pre>
            </p>
          </div>
        
          
          
          
        </div>
        
        
        
      </div>
    </div>

    <div class="md:flex-none md:w-48 bg-white dark:bg-zinc-800 shadow-md p-4 space-y-4" id="parameters-section">
      <div class="flex justify-center items-center cursor-pointer" onclick="toggleParameters()">
        <div style="color:gray" class="text-lg font-semibold text-zinc-800 dark:text-zinc-200">Parameters</div>
        <svg class="w-4 h-4 ml-1 transform transition duration-200" id="parameters-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
      <ul class="hidden space-y-2" id="parameters-list">
        <li>Parameter 1</li>
        <li>Parameter 2</li>
        <li>Parameter 3</li>
      </ul>
    </div>
  </div>

  <div id="modal-0" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md space-y-4" id="modal-content-0">
      <img src="welcome2.jpg" alt="generated image" class="w-full h-auto" id="modal-image-0" />
      <div class="flex space-x-4" id="modal-buttons-0">
        <button
          class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
          id="download-btn">Download</button>
        <button
          class="p-2 bg-green-500 text-white rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500"
          id="animate-btn">Animate</button>
      </div>
    </div>
  </div>
  
  

  <script>
    function toggleParameters() {
      const parametersList = document.getElementById('parameters-list');
      const arrow = document.getElementById('parameters-arrow');

      parametersList.classList.toggle('hidden');
      arrow.classList.toggle('rotate-180'); 
    }
  </script>



  <script src="beep.jsi"></script>
  <script>
    let message_interaction = `
    <div>
      <div class="bg-blue-500 text-white p-4 rounded-lg shadow-md self-end text-lg" id="user-message-!!REQNO!!">
        <p>!!USER-REQUEST!!</p>
      </div>
      <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" id="gpt-message--!!REQNO!!"> 
<!--      <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex items-start space-x-4 text-lg"
        id="gpt-message-!!REQNO!!">-->
        <img src="https://placehold.co/200x200" width="200" height="200" alt="generated image"
          class="rounded-md shadow-md cursor-pointer" id="gpt-image-!!REQNO!!" />
        
        <pre style = "white-space: pre-wrap" text-zinc-800 dark:text-zinc-200 ><p id="gpt-text-!!REQNO!!" class="text-zinc-800 dark:text-zinc-200"></p>
        </pre>  
          
        
      </div>
    </div>
  `;
  
  let picture_modal = `
  <div id="modal-!!REQNO!!" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md space-y-4" id="modal-content-!!REQNO!!">
      <img src="!!IMGSRC!!" alt="generated image" class="w-full h-auto" id="modal-image-!!REQNO!!" />
      <div class="flex space-x-4" id="modal-buttons-!!REQNO!!">
        <button
          class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
          id="download-btn">Download</button>
        <button
          class="p-2 bg-green-500 text-white rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500"
          id="animate-btn">Animate</button>
      </div>
    </div>
  </div>
  `;
  
  
  
  
    let interaction_no = 0;
    
    function textToHtml(text) {
      const entities = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&apos;'
      };

      return text.replace(/[&<>"']/g, (match) => entities[match]);
    }

    
    function add_interaction(message){
        interaction_no += 1;
        
        const newHtml = message_interaction.replace("!!USER-REQUEST!!",textToHtml(message)).split("!!REQNO!!").join(interaction_no+"");
        let e = document.getElementById("chat-messages-area");
        //If I have a html code as a string, then I want to make it to html object and insert it after another existing object. How do I do it?
        const newDiv = document.createElement("div");
        newDiv.innerHTML = newHtml;
        e.insertBefore(newDiv, e.firstChild);
        //e.after(newDiv);
        return interaction_no;
    }
  
  
  
  
    function run_message(message){
        let reqno = add_interaction(message);
        
        let messageBox = document.getElementById("message-box");
        messageBox.value = "";
        messageBox.style.height = 'auto';
        messageBox.style.height = messageBox.scrollHeight + 'px';
        
        
        
        fetch('routers/falai/falai.php?content='+encodeURIComponent(message))
          .then(response => response.json())
          .then(data => {
            document.getElementById("gpt-image-"+reqno).src = data.image;
            console.log(data);
            
            const newHtml = picture_modal.split("!!REQNO!!").join(interaction_no+"").split("!!IMGSRC!!").join(data.image);
            
            let e = document.getElementById("modal-0");
            const newDiv = document.createElement("div");
            newDiv.innerHTML = newHtml;
            e.parentNode.insertBefore(newDiv, e);
            
            
            make_modal(reqno);
            //modal
            
            
            
            
          })
          .catch(error => {
            console.error('Error:', error);
          });
        
        let llm_url = document.getElementById("model-select").value;
        //fetch('groq.php?content='+message)
        
        
        fetch(llm_url+'&content='+encodeURIComponent(message))
        //fetch('tes.php?content='+message)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.body;
          })
          .then(stream => {
            const reader = stream.getReader();
            const decoder = new TextDecoder();

            // Read the stream in chunks
            function read() {
              return reader.read().then(({ done, value }) => {
                if (done) {
                  console.log('Stream reading complete');
                  return;
                }

                // Decode the chunk to a string and log it
                let elem = document.getElementById("gpt-text-"+reqno);
                elem.innerHTML = elem.innerHTML+textToHtml(decoder.decode(value));
                
                console.log(decoder.decode(value));

                // Read the next chunk
                return read();
              });
            }

            // Start reading the stream
            return read();
          })
          .catch(err => console.error(err));
    }
    
      document.getElementById('sidebar-toggle').addEventListener('click', () => {
          document.getElementById('sidebar-menu').classList.toggle('hidden');
        });
    
    
    function make_modal(reqno){
   
      

        document.getElementById('gpt-image-'+reqno).addEventListener('click', () => {
            console.log("clicked");
          document.getElementById('modal-'+reqno).classList.remove('hidden');
        });

        document.getElementById('download-btn').addEventListener('click', () => {
          const link = document.createElement('a');
          link.href = document.getElementById('modal-image-'+reqno).src;
          link.download = 'generated image';
          link.click();
        });

        document.getElementById('animate-btn').addEventListener('click', () => {
          const image = document.getElementById('modal-image-'+reqno);
          image.classList.add('animate-bounce');
          setTimeout(() => image.classList.remove('animate-bounce'), 1000);
        });

        document.getElementById('modal-'+reqno).addEventListener('click', (e) => {
          if (e.target === document.getElementById('modal-'+reqno)) {
            document.getElementById('modal-'+reqno).classList.add('hidden');
          }
        });
    
    
    }
    make_modal(0);

    



    // Speech-to-text
    const microphoneBtn = document.getElementById('microphone-btn');

    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    if(window.SpeechRecognition){
        recognition = new SpeechRecognition("sv-SE");
    }
    else recognition = {};
    //recognition.continuous = true; 
    recognition.lang = "sv-SE";

    function beep() {
            const audio = new Audio(audiofile); // Very short beep sound
      audio.play();
    }

    microphoneBtn.addEventListener('click', () => {
      if (recognition.continuous) {
        recognition.continuous = false;
        recognition.stop();
        microphoneBtn.classList.remove('bg-red-500', 'text-white');
        microphoneBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');
        //beep();
      } else {
        recognition.continuous = true;
        recognition.start();
        recognition.continuous = true;
        beep();
        microphoneBtn.classList.add('bg-red-500', 'text-white');
        microphoneBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
      }
    });

    recognition.onresult = (event) => {
      const transcript = event.results[event.results.length-1][0].transcript;
      console.log(event.results);
      if(transcript.replace(/\s/g, "")=="stopstop"){
        recognition.continuous = false;
        recognition.stop();
        microphoneBtn.classList.remove('bg-red-500', 'text-white');
        microphoneBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');
      }
      else messageBox.value += transcript + ' '; 
       
    };

    recognition.onend = () => {
      microphoneBtn.classList.remove('bg-red-500', 'text-white');
      microphoneBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');
      recognition.stop();
       recognition.continuous = false;
 
      beep();
      run_message(document.getElementById('message-box').value);
      document.getElementById('message-box').value="";
      //recognition = new SpeechRecognition();
    };
  </script>
</body>
</html>
