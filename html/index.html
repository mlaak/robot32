<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Interface</title>
  <script src="https://cdn.tailwindcss.com/3.4.3"></script>
</head>
<body class="bg-zinc-100 dark:bg-zinc-900">

<div id="screen" class="flex flex-col md:flex-row h-screen">
    
    <div id="sidebar" class="md:flex-none md:w-48 bg-white dark:bg-zinc-800 shadow-md p-4 space-y-4" >
      <div class="flex justify-between items-center md:block">
        <div class="text-lg font-semibold text-zinc-800 dark:text-zinc-200" id="sidebar-title">Menu</div>
        <button class="md:hidden p-2 bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200 rounded-md focus:outline-none"
          id="sidebar-toggle">
          â˜°
        </button>
      </div>     
      <!--    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <!-- dont remove this comment here -->
    <div class="">
     <ul class="space-y-2 mt-4 md:mt-0 hidden md:block" id="sidebar-menu">
        <li><a href="index.html"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-home-link">Home</a></li>
        <li><a href="login.html"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-profile-link">Login</a></li>
        <li><a href="units/settings"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-settings-link">Settings</a></li>
        <li><a href="units/logout"
            class="block p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200"
            id="sidebar-logout-link">Logout</a></li>
      </ul>
     </div> 
    </div> <!--sidebar-->


    <div id="main-content" class="flex flex-col flex-1" >  
      <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div class="flex-none p-4 bg-white dark:bg-zinc-800 shadow-md flex flex-col md:flex-row items-end md:items-end space-x-2"
id="chat-input-area">
<div id="message-input-container" style="width:100%" class="flex-grow relative flex items-center" >
 
  <button id="microphone-btn"
    class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    aria-label="Speak">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" fill="none"
      viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3m0 0A3 3 0 0111 4m6 0a6 6 0 016 6" />
    </svg>
  </button>
  
  <div class="relative w-full" id="message-input-wrapper">
   
    <textarea style="min-height:87px" id="message-box" placeholder="Type a message..."
      class="w-full p-2 border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-zinc-700 dark:border-zinc-600 dark:placeholder-zinc-400 dark:text-white pr-12 text-lg resize-none overflow-hidden" run_button="run-button"></textarea>
      
    <label
      class="absolute right-2 bottom-2 p-2 bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-white rounded-md shadow-md cursor-pointer hover:bg-zinc-300 dark:hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center space-x-2"
      id="file-upload-label">
      <input type="file" class="hidden" id="file-upload-input" />
      <img aria-hidden="true" alt="upload" src="https://placehold.co/20x20?text=ðŸ“¤" />
    </label>
    
  </div>
</div>        


<div class="flex flex-col w-full md:w-auto mt-2 md:mt-0 space-y-2 md:space-y-0" id="chat-options">
  
  <select
    class="p-2 border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-zinc-700 dark:border-zinc-600 dark:text-white text-lg w-full md:w-auto"
    id="model-select">
    <!--<option value="routers/groq/groq.php?model=mixtral-8x7b-32768">R32-M</option>-->
    
    <option value="R32">R32!</option>
    <option value="experts/general?model=mistralai/mixtral-8x7b-instruct">R32-M</option>
    <option value="experts/general?model=mistralai/mixtral-8x22b-instruct">R32-L</option>
    <option value="experts/fake?model=fake">FAKE LLM</option>
    <option value="experts/classifier?model=mistralai/mixtral-8x7b-instruct">Classifier</option>
    <option value="experts/remote_llms?model=openai/gpt-4o-2024-05-13">$ GPT-4o</option>
    <option value="experts/remote_llms?model=google/gemini-flash-1.5">$ Gemini-F</option>
    <option value="experts/remote_llms?model=perplexity/llama-3-sonar-large-32k-online">$ Perplexity</option>
    <option value="experts/remote_llms?model=anthropic/claude-3.5-sonnet">$ Claude-3.5</option>    
  </select>
  
  <button style="margin-top:7px"
    class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg w-full md:w-auto"
    id="run-button" onclick="run_message(document.getElementById('message-box').value);document.getElementById('message-box').value='';">RUN</button>
    
</div>
</div>

<script> 
const messageBox = document.getElementById('message-box');

// Automatically adjust input box height
messageBox.addEventListener('input', () => {
  console.log("?");
  messageBox.style.height = 'auto';
  let h = messageBox.scrollHeight;
  if(h>400)h=400;
  messageBox.style.height = h + 'px';
  
  
});

// Ctrl+Enter = RUN
document.addEventListener('keydown', function(event) {
  if (event.key === 'Enter' && event.ctrlKey) {
    console.log('Ctrl+Enter pressed');
        //if(document.activeElement.id=="message-box")run_message(document.getElementById('message-box').value);
        
        
        console.log(document.activeElement);
        console.log(document.activeElement.dataset.run_button);
        
        if(document.activeElement && document.activeElement.getAttribute('run_button')){
            var run_button = document.activeElement.getAttribute('run_button');
            document.getElementById(run_button).click();
        }
        
        
        
  }
});


</script>

<!-- end of file -->


 
      <!--    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <!-- dont remove this comment here -->
    
    <a href="#" id="more-options-link" class="block text-blue-500 dark:text-blue-300 mt-2 ml-4">More options >></a>
      <div id="more-options" class="hidden mt-2 space-y-2 ml-4">
        <button class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg w-full md:w-auto" onclick="deleteAllLLMInteractions()">Clear board</button>
        <select style="height: 43px;" class="text-lg rounded-md" id = "illustrator_choice">
          <option value="default">Illustrator: default</option>
          <option value="realistic">Illustrator: realistic</option>
          <option value="funny">Illustrator: funny</option>
        </select>
        <!--
        <label class="flex items-center space-x-2" id="option1-label">
          <input type="checkbox" class="form-checkbox text-blue-500 dark:text-blue-300" id="option1-checkbox" />
          <span class="text-zinc-800 dark:text-zinc-200">Option 1</span>
        </label>
        <label class="flex items-center space-x-2" id="option2-label">
          <input type="checkbox" class="form-checkbox text-blue-500 dark:text-blue-300" id="option2-checkbox" />
          <span class="text-zinc-800 dark:text-zinc-200">Option 2</span>
        </label>
        <label class="flex items-center space-x-2" id="option3-label">
          <input type="checkbox" class="form-checkbox text-blue-500 dark:text-blue-300" id="option3-checkbox" />
          <span class="text-zinc-800 dark:text-zinc-200">Option 3</span>
        </label>
        -->
      </div>
      
    <script>
    document.getElementById('more-options-link').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('more-options').classList.toggle('hidden');
    });
    </script> 
  

      <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages-area">
        <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md text-lg" id="initial-message">
          <p class="text-zinc-800 dark:text-zinc-200">Hello! How can I assist you today? <button class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg w-full md:w-auto" onclick="load_previous_chat();">Load previous</button> </p>
        </div>
        <div> 
  <div class="bg-blue-500 text-white p-4 rounded-lg shadow-md self-end text-lg " id="user-message">
    <p>What is robot32-chat and what can I do with it.</p>
  </div>

  <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" id="gpt-message">  
    <img src="/welcome2.jpg" width="200" height="200" alt="generated image"
      class="rounded-md shadow-md cursor-pointer" id="gpt-image-0" />
      <pre style = "white-space: pre-wrap" ><p class="text-zinc-800 dark:text-zinc-200">Robot32-chat is large language model based on open source LLM. 
Type in your question (or picture idea) and hit the RUN button.
You can try:
What is the capital of Sweden?
What is the smallest whale?
Make me pythonc function that sorts custom objects be given param.
A serene forest landscape at sunset, glassy lake reflecting the sky.
A surreal, dreamlike landscape with floating islands.
  
Image generation is based on open source model Stable Diffusion Turbo (v1.5/XL)
    </pre>
    </p>
  </div>  
</div>
      </div>  <!--chat-messages-area-->
      
    </div> <!--main-content-->
    
    
    <div id="parameters-section" class="md:flex-none md:w-48 bg-white dark:bg-zinc-800 shadow-md p-4 space-y-4">
        <div id="credits_display" >
</div>
<div style="margin-top:0px" class="flex justify-center items-center cursor-pointer" onclick="toggleParameters()">
    <div style="color:gray" class="text-lg font-semibold text-zinc-800 dark:text-zinc-200">Parameters</div>
    <svg class="w-4 h-4 ml-1 transform transition duration-200" id="parameters-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
</div>
<div style="margin-top: 0px;" class="justify-center flex">
<ul style="margin-top: 0px;" class="hidden " id="parameters-list">
    <li>
        <select id="llm_temp">
          <option value="0.0">Temp 0.0</option>
          <option value="0.2">Temp 0.2</option>
          <option value="0.4">Temp 0.4</option>
          <option value="0.6">Temp 0.6</option>
          <option value="0.8">Temp 0.8</option>
          <option value="1.0" selected>Temp 1.0</option>
          <option value="1.2">Temp 1.2</option>
          <option value="1.4">Temp 1.4</option>
          <option value="1.6">Temp 1.6</option>
          <option value="1.8">Temp 1.8</option>
          <option value="2.0">Temp 2.0</option>
        </select>
    </li>
   
    <li>
      <select id = "llm_top_p">
        <option value="0.0">Top-P 0.0</option>
        <option value="0.1">Top-P 0.1</option>
        <option value="0.2">Top P 0.2</option>
        <option value="0.3">Top P 0.3</option>
        <option value="0.4">Top P 0.4</option>
        <option value="0.5">Top P 0.5</option>
        <option value="0.6">Top P 0.6</option>
        <option value="0.7">Top P 0.7</option>
        <option value="0.8">Top P 0.8</option>
        <option value="0.9">Top P 0.9</option>
        <option value="1.0" selected>Top P 1.0</option>
      </select>
  </li>

  <li>
    <select id = "llm_max_tokens">
      <option value="100">Max 100 tokens</option>
      <option value="200">Max 200 tokens</option>
      <option value="400">Max 400 tokens</option>
      <option value="800">Max 800 tokens</option>
      <option value="1600">Max 1600 tkns</option>
      <option value="3200" selected>Max 3200 tkns</option>
      <option value="6400">Max 6400 tkns</option>
      <option value="12800">Max 12800 tkn</option>
    
    </select>
</li>

</ul>
</div>


<script>
    function toggleParameters() {
      const parametersList = document.getElementById('parameters-list');
      const arrow = document.getElementById('parameters-arrow');

      parametersList.classList.toggle('hidden');
      arrow.classList.toggle('rotate-180'); 
    }
</script>

  
    </div>
        
</div>  <!--screen-->


<div id="modal-0" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md space-y-4" id="modal-content-0">
      <img src="welcome2.jpg" alt="generated image" class="w-full h-auto" id="modal-image-0" />
          <div class="flex space-x-4" id="modal-buttons-0">
            <button
              class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
              id="download-btn">Download</button>
            <button
              class="p-2 bg-green-500 text-white rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500"
              id="animate-btn">Animate</button>
          </div>
    </div>
</div>
  
<div id="templates" style="display:none">     
    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="template_reply_to_message" style="display:hidden">

<div id="reply-to-message-div-!!REQNO!!" class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" >
  
    <textarea style="min-height: 45px; height: 45px;" id="reply-to-message-box-!!REQNO!!" placeholder="Type a reply..." class="w-full p-2 border border-zinc-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-zinc-800 dark:border-zinc-600 dark:placeholder-zinc-600 dark:text-white pr-12 text-lg resize-none overflow-hidden" run_button="run-button--!!REQNO!!"></textarea> 
  
    <button style="height: 45px; width: 80px"  class="p-2 bg-white dark:bg-zinc-800 text-zinc-400  dark:text-zinc-600 focus:text-white  border border-zinc-300 dark:border-zinc-600 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg w-full" id="run-button--!!REQNO!!" onclick="run_message_continue(this.parentElement.parentElement,this.parentElement,document.getElementById('reply-to-message-box-!!REQNO!!').value);">RUN</button>
  
</div> <!--reply-to-message-div-!!REQNO!!-->

</div>
    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="template_message_interaction" style="display:hidden">


<div id="interaction-!!REQNO!!">
  <div id="user-message-!!REQNO!!" role="user" chat="" class="bg-blue-500 text-white p-4 rounded-lg shadow-md self-end text-lg">
    <p>!!USER-REQUEST!!</p>
  </div>
  
  
  <div id="gpt-message--!!REQNO!!" role="ai" chat="" class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" > 
    <img src="https://placehold.co/200x200" width="200" height="200" alt="generated image" class="rounded-md shadow-md cursor-pointer" id="gpt-image-!!REQNO!!" />
    <pre style = "white-space: pre-wrap" ><p id="gpt-text-!!REQNO!!" class="text-zinc-800 dark:text-zinc-200"></p>
    </pre>  
  </div> <!--gpt-message--!!REQNO!!-->
</div>



      
</div>
    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="template_message_continue" style="display:hidden">


<div id="interaction-cont-!!REQNO!!">
  <div id="user-message-cont-!!REQNO!!" role="user" chat="" class="bg-teal-500 text-white p-4 rounded-lg shadow-md self-end text-lg">
    <p>!!USER-REQUEST!!</p>
  </div>
  
  
  <div id="gpt-message-cont-!!REQNO!!" role="ai" chat="" class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" > 
    <pre style = "white-space: pre-wrap" ><p id="gpt-text-cont-!!REQNO!!" class="text-zinc-800 dark:text-zinc-200"></p>
    </pre>  
  </div> <!--gpt-message--!!REQNO!!-->
</div>
      
</div>
    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="template_picture_modal" style="display:hidden">
    <div id="modal-!!REQNO!!" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md space-y-4" id="modal-content-!!REQNO!!">
          <img src="!!IMGSRC!!" alt="generated image" class="w-full h-auto" id="modal-image-!!REQNO!!" />
          <div class="flex space-x-4" id="modal-buttons-!!REQNO!!">
            <button
              class="p-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
              id="download-btn">Download</button>
            <button
              class="p-2 bg-green-500 text-white rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500"
              id="animate-btn">Animate</button>
          </div>
        </div>
    </div>
</div>

    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="tpl_ai_response_cont" style="display:hidden">

  <div id="gpt-message--!!REQNO!!" role="ai" chat="" class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" > 
    <pre style = "white-space: pre-wrap" ><p id="gpt-text-!!REQNO!!" class="text-zinc-800 dark:text-zinc-200">!!AI-RESPONSE!!</p>
    </pre>  
  </div> <!--gpt-message--!!REQNO!!-->

</div>

    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="tpl_ai_response_initial" style="display:hidden">

  <div id="gpt-message--!!REQNO!!" role="ai" chat="" class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-start space-y-4 sm:space-y-0 sm:space-x-4 text-lg" > 
    <img src="!!IMG-LINK!!" width="200" height="200" alt="generated image" class="rounded-md shadow-md cursor-pointer" id="gpt-image-!!REQNO!!" />
    <pre style = "white-space: pre-wrap" ><p id="gpt-text-!!REQNO!!" class="text-zinc-800 dark:text-zinc-200">!!AI-RESPONSE!!</p>
    </pre>  
  </div> <!--gpt-message--!!REQNO!!-->

</div>

    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="tpl_interaction" style="display:hidden">

<div id="interaction-!!REQNO!!">

</div>

</div>
        <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="tpl_usr_query_cont" style="display:hidden">

  <div id="user-message-!!REQNO!!" role="user" chat="" class="bg-teal-500 text-white p-4 rounded-lg shadow-md self-end text-lg">
    <p>!!USER-REQUEST!!</p>
  </div>
  
</div>    <!--<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<!-- dont remove this comment here -->

<div id="tpl_usr_query_initial" style="display:hidden">

  <div id="user-message-!!REQNO!!" role="user" chat="" class="bg-blue-500 text-white p-4 rounded-lg shadow-md self-end text-lg">
    <p>!!USER-REQUEST!!</p>
  </div>
  
</div>
</div>  
 

<script src="beep.jsi"></script>
<script>

    function textToHtml(text) {
  const entities = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&apos;'
  };
  return text.replace(/[&<>"']/g, (match) => entities[match]);
}


function getCookie(name) {
  const cookieString = document.cookie;
  const cookieStart = cookieString.indexOf(`${name}=`);
  if (cookieStart === -1) {
    return null;
  }
  const cookieEnd = cookieString.indexOf(';', cookieStart);
  if (cookieEnd === -1) {
    return cookieString.substring(cookieStart + name.length + 1);
  }
  return cookieString.substring(cookieStart + name.length + 1, cookieEnd);
}


function checkCookieExists(name) {
  const cookies = document.cookie.split(';');
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i].trim();
    if (cookie.startsWith(name + '=')) {
      return true;
    }
  }
  return false;
}

function naturalSort(arr) {
  const collator = new Intl.Collator(undefined, {
      numeric: true,
      sensitivity: 'base'
  });
  return arr.sort(collator.compare);
}

async function decryptText(dt,secretKey){
  dt = JSON.parse(dt);
  let decrypted = null;
  try{
    let iva = new Uint8Array(dt.iv);
    let ena = new Uint8Array(dt.encrypted);
  
    decrypted = await window.crypto.subtle.decrypt(
      {name: "AES-GCM",iv: iva},
      secretKey,ena
    );
  }
  catch(e){
    console.log("GOT ERROR from window.crypto.subtle.decrypt",e);
    return null;
  }

  let dec = new TextDecoder();
  return dec.decode(decrypted);
}

async function encryptText(txt,secretKey){
  const textEncoder = new TextEncoder();
  let dt = textEncoder.encode(txt);
  let iv = window.crypto.getRandomValues(new Uint8Array(12)); // the initialization vector should be unique for each encryption
  const encryptedData = await window.crypto.subtle.encrypt(
    {
      name: 'AES-GCM',
      iv: iv
    },
    secretKey,
    dt
  );
  let ee= Array.from(new Uint8Array(encryptedData));
  let decrypted = await window.crypto.subtle.decrypt(
    {name: "AES-GCM",iv: iv},
    secretKey,new Uint8Array(ee)
  );

  return JSON.stringify({"iv":Array.from(iv),"encrypted":Array.from(new Uint8Array(encryptedData))});
}

function getSelectBoxValue(id) {
  let selectBox = document.getElementById(id);
  let selectedValue = selectBox.options[selectBox.selectedIndex].value;
  return selectedValue;
}

function deleteAllLLMInteractions(){
  var elements = document.querySelectorAll('.llm_interaction');
  // Loop through the elements and remove them from the DOM
  for (var i = 0; i < elements.length; i++) {
    elements[i].remove();
  }
}
    if(!checkCookieExists('r_ression_id')){
        window.location.href="login.html";
    }

    var ClientSecretKey=null;
    async function loadSecret(){
        try{
          var cook = getCookie("r_user_secret");
          if(cook!=null){
            var secret = decodeURIComponent(cook);
            ClientSecretKey = await window.crypto.subtle.importKey("jwk",JSON.parse(secret),"AES-GCM",true, ['encrypt', 'decrypt']);
          }
        }
        catch(err){
          console.log(err);
        }
    }
    loadSecret();

    document.getElementById('sidebar-toggle').addEventListener('click', () => {
          document.getElementById('sidebar-menu').classList.toggle('hidden');
    });


    function checkCredits(displayElement) {
      // Make sure displayElement is a valid DOM element
      if (!(displayElement instanceof Element)) {
        console.error('Invalid display element provided');
        return;
      }

      // Make the API call
      fetch('units/credits_check?no_caching='+Date.now())
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(credits => {
          // Display the credits
          if(credits=="-1")displayElement.textContent = "";
          else displayElement.textContent = `Credits: ${credits}`;
        })
        .catch(error => {
          console.error('Error:', error);
          displayElement.textContent = 'Error checking credits';
        });
    }

    checkCredits(document.getElementById("credits_display"));

    function template(name,...replaces){ 
    var s = document.getElementById(name).innerHTML;
    
    if(replaces){
        replaces.forEach(function(r) {
            s = s.split(r[0]).join(r[1]);
        });
    }
    var newDiv = document.createElement("div");
    newDiv.innerHTML = s;
    return newDiv;
}

function findParentByClassName(element, className) {
    let currentElement = element;
  
    if (currentElement.classList.contains(className)) {
        return currentElement;
    }

    while (currentElement && currentElement.parentNode) {
      currentElement = currentElement.parentNode;
  
      if (currentElement.classList.contains(className)) {
        return currentElement;
      }
    }
    return null; // return null if not found
}



let interaction_no = 0;

interaction_no = localStorage.getItem("reqno")*1;

function add_interaction_continue(el,el2,message){
    interaction_no += 1;

    el.removeChild(el2);    
     let message_interaction = template("template_message_continue",
                                ["!!USER-REQUEST!!",textToHtml(message)],
                                ["!!REQNO!!",interaction_no+""]);   
     el.appendChild(message_interaction);      
     document.getElementById("user-message-cont-"+interaction_no).setAttribute("chat",message);
     add_reply_to(el);
     return interaction_no;               
    
}


function add_reply_to(el){
    let reply_to = template("template_reply_to_message", ["!!REQNO!!",interaction_no+""]);
    el.appendChild(reply_to);
}

function add_interaction(message){
    interaction_no += 1;    
    let cma = document.getElementById("chat-messages-area");

    let message_interaction = template("template_message_interaction",
                                ["!!USER-REQUEST!!",textToHtml(message)],
                                ["!!REQNO!!",interaction_no+""]); 

    message_interaction.classList.add("llm_interaction");
    message_interaction.setAttribute("interaction_no",interaction_no);
      
    cma.insertBefore(message_interaction, cma.firstChild);
    document.getElementById("user-message-"+interaction_no).setAttribute("chat",message);
    
    add_reply_to(cma.firstChild);
    
    return interaction_no;
    
}



function restore_interaction(reqno,img,history){
    if(history == null)return 0;
    if(document.getElementById("interaction-"+reqno)!=null)return 0;

    let cma = document.getElementById("chat-messages-area");
        
    let message_interaction = template("tpl_interaction",
                                ["!!REQNO!!",reqno]); 

    message_interaction.classList.add("llm_interaction");
    message_interaction.setAttribute("interaction_no",reqno);
      
    cma.insertBefore(message_interaction, document.getElementById("initial-message"));
    
    let firstUser = true;
    let firtResponse = true;

    for(i=0;i<history.length;i++){
        let h = history[i]+"";
        if(h.startsWith("user:")){
            let mess = h.substring(5);
            interaction_no += 1;

            if(firstUser){
                var usrt = template("tpl_usr_query_initial", 
                    ["!!USER-REQUEST!!",textToHtml(mess)],
                    ["!!REQNO!!",interaction_no+""]);
                firstUser = false;
            } else {
                var usrt = template("tpl_usr_query_cont", 
                    ["!!USER-REQUEST!!",textToHtml(mess)],
                    ["!!REQNO!!",interaction_no+""]);
            }

            message_interaction.appendChild(usrt);
        }
        else if(h.startsWith("ai:")){
            let mess = h.substring(3);
            interaction_no += 1;
            if(firtResponse){
                var airesp = template("tpl_ai_response_initial",
                    ["!!IMG-LINK!!",img], 
                    ["!!AI-RESPONSE!!",textToHtml(mess)],
                    ["!!REQNO!!",interaction_no+""]);
                firtResponse = false;
            }
            else {
                var airesp = template("tpl_ai_response_cont", 
                    ["!!AI-RESPONSE!!",textToHtml(mess)],
                    ["!!REQNO!!",interaction_no+""]);
            }
            message_interaction.appendChild(airesp);
        }
    }
    
    return interaction_no;
}




    function load_previous_chat(){
    do_load_previous_chat();
}

async function do_load_previous_chat(){
    let all_keys = Object.keys(localStorage);
    all_keys = naturalSort(all_keys);
    all_keys = all_keys.reverse();

    let displayed = 0;
    let max = 10;

    for (let i = 0; i < all_keys.length; i++) {
        if(all_keys[i].startsWith("history")){
            let r = await load_chat_part(all_keys[i]);
            if(r!=0){
                displayed++;
            }
            if(displayed>=max)break; 
        }
        console.log(all_keys[i]);
    }
}

async function load_chat_part(id){
    let num = id.substring(7)*1;
    let dt = localStorage.getItem(id);

    let decrypted =await decryptText(dt,ClientSecretKey);
    let dat = JSON.parse(decrypted);

    let img_dt = localStorage.getItem("img"+num);
    let img_src = "";
    if(img_dt!=null){
        img_src = await decryptText(img_dt,ClientSecretKey);
    }

    return restore_interaction(num,img_src,dat);
}


 
    function get_chat_history(element,out = []){
  for (let i = 0; i < element.children.length; i++) {
    const child = element.children[i];
    if(child.getAttribute('role') == "user" || child.getAttribute('role') == "ai"){
      out.push(child.getAttribute('role')+":"+child.getAttribute('chat'));
    }
    else if(child.tagName=="DIV"){
      get_chat_history(child,out);
    }
  }
  return out;
}

async function saveHistoryImg(parent_req_no,val){
  let encryptedData = await encryptText(val,ClientSecretKey);
  localStorage.setItem("img"+parent_req_no,encryptedData);
}

async function saveHistory(history,parent_req_no){
  let encryptedData = await encryptText(JSON.stringify(history),ClientSecretKey);        
  localStorage.setItem("history"+parent_req_no,encryptedData);
  console.log(localStorage.getItem("history"+parent_req_no));
}
  
function run_llm_query(llm_url,parent_req_no,message,history,gpt_text_elem){
    let history_str = "";
    let llm_response = "";

    //TODO: make this more sane (function should probably take these in as parameters)
    var llm_temp = getSelectBoxValue("llm_temp");
    var llm_top_p = getSelectBoxValue("llm_top_p");
    var llm_max_tokens = getSelectBoxValue("llm_max_tokens");


    if(history!=null){
        history_str = "&history="+encodeURIComponent(JSON.stringify(history));
    }
    fetch(llm_url+'&content='+encodeURIComponent(message)+history_str+"&llm_temp="+llm_temp+"&llm_top_p="+llm_top_p+"&llm_max_tokens="+llm_max_tokens , {credentials: "same-origin"})
      .then(response => {

        checkCredits(document.getElementById("credits_display"));

        if (!response.ok) {
            if(response.status==498){
                window.location.href="login.html";
            }    
            const headerString = Array.from(response.headers.entries())
              .map(([key, value]) => `${key}: ${value}`)
              .join('\n');
            gpt_text_elem.innerHTML = gpt_text_elem.innerHTML+textToHtml(headerString+"");              
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.body;
      })
      .then(stream => {
        const reader = stream.getReader();
        const decoder = new TextDecoder();

        // Read the stream in chunks
        function read() {
          return reader.read().then(({ done, value }) => {
            if (done) {
              if(history==null)history = [];
              history.push("user:"+message);
              history.push("ai:"+llm_response);
              saveHistory(history,parent_req_no);
              return;
            }

            llm_response+=decoder.decode(value);

            gpt_text_elem.innerHTML = gpt_text_elem.innerHTML+textToHtml(decoder.decode(value));
            gpt_text_elem.parentNode.parentNode.setAttribute("chat",gpt_text_elem.parentNode.parentNode.getAttribute("chat")+decoder.decode(value));
            
            return read(); // Read the next chunk
          });
        }
        // Start reading the stream
        return read();
      })
      .catch(err => console.error(err));        
}
  
function run_message_continue(el,el2,message){
    //let reqno = add_interaction(message);
    
    llm_chat = findParentByClassName(el,"llm_interaction");
    let history = get_chat_history(llm_chat);
    
    let reqno = add_interaction_continue(el,el2,message);
    

    var prn = findParentByClassName(el,"llm_interaction");
    let parent_req_no = prn.getAttribute("interaction_no");

    localStorage.setItem("reqno",reqno);

    let llm_url = document.getElementById("model-select").value;
    gpt_text_elem = document.getElementById("gpt-text-cont-"+reqno);
    
    if(llm_url!="R32"){
      run_llm_query(llm_url,parent_req_no,message,history,gpt_text_elem);
    }
    else {
      let expert_url = llm_chat.getAttribute("expert_url");
      if(!expert_url)expert_url = "experts/general?model=auto";
      run_llm_query(expert_url,parent_req_no,message,history,gpt_text_elem);
    }
    
}
    
function run_message(message){
    let reqno = add_interaction(message);
    
    localStorage.setItem("reqno",reqno);

    let messageBox = document.getElementById("message-box");
    messageBox.value = "";
    messageBox.style.height = 'auto';
    messageBox.style.height = messageBox.scrollHeight + 'px';
    
    fetch('experts/illustrator?content='+encodeURIComponent(message)+"&illustrator_choice="+getSelectBoxValue("illustrator_choice"),{credentials: "same-origin"})
      .then(response => {
        var imgdata = response.headers.get("Return-Image");
        document.getElementById("gpt-image-"+reqno).src = "data:image/jpeg;base64,"+imgdata;
        return response.json();
      })
      .then(data => {
        document.getElementById("gpt-image-"+reqno).src_link = data.image;
        
        saveHistoryImg(reqno,data.image);

        var picture_modal = document.getElementById("template_picture_modal").innerHTML;
        const newHtml = picture_modal.split("!!REQNO!!").join(interaction_no+"").split("!!IMGSRC!!").join(data.image);
        
        let e = document.getElementById("modal-0");
        const newDiv = document.createElement("div");
        newDiv.innerHTML = newHtml;
        e.parentNode.insertBefore(newDiv, e);
        
        make_modal(reqno);
          
      })
      .catch(error => {
        console.error('Error:', error);
      });
    
    let llm_url = document.getElementById("model-select").value;
    gpt_text_elem = document.getElementById("gpt-text-"+reqno);

    let llm_chat = findParentByClassName(gpt_text_elem,"llm_interaction");
    
    if(llm_url!="R32"){
      run_llm_query(llm_url,reqno,message,null,gpt_text_elem);
    }
    else {
      fetch('experts/classifier?model=mistralai/mixtral-8x7b-instruct&content='+encodeURIComponent(message),{credentials: "same-origin"})
      .then(response => response.text())
      .then(data => {

        if(data.includes("H0")){
          run_llm_query("experts/humorist?a=1",reqno,message,null,gpt_text_elem);
          llm_chat.setAttribute("expert_url","experts/humorist?a=1");
        }
        else if( data.includes("G0") ){

          llm_chat.setAttribute("expert_url","experts/general?model=auto");
          run_llm_query("experts/general?model=auto",reqno,message,null,gpt_text_elem);
        }
        else {
          llm_chat.setAttribute("expert_url","experts/robotics?model=auto");
          run_llm_query("experts/robotics?model=auto",reqno,message,null,gpt_text_elem);
        }

        /*
        if(data.includes("HUM")){
          run_llm_query("experts/humorist?a=1",reqno,message,null,gpt_text_elem);
          llm_chat.setAttribute("expert_url","experts/humorist?a=1");
        }
        else if(data.includes("CCELE") || data.includes("CCPRO") || data.includes("CCAI") || 
          data.includes("CCTEC")    
        ){
          llm_chat.setAttribute("expert_url","experts/robotics?model=auto");
          run_llm_query("experts/robotics?model=auto",reqno,message,null,gpt_text_elem);
        }
        else {
          llm_chat.setAttribute("expert_url","experts/general?model=auto");
          run_llm_query("experts/general?model=auto",reqno,message,null,gpt_text_elem);
        }
        */

      });
    }
}
 
    function make_modal(reqno){
    document.getElementById('gpt-image-'+reqno).addEventListener('click', () => {
        console.log("clicked");
      document.getElementById('modal-'+reqno).classList.remove('hidden');
    });

    document.getElementById('download-btn').addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = document.getElementById('modal-image-'+reqno).src;
      link.download = 'generated image';
      link.click();
    });

    document.getElementById('animate-btn').addEventListener('click', () => {
      const image = document.getElementById('modal-image-'+reqno);
      image.classList.add('animate-bounce');
      setTimeout(() => image.classList.remove('animate-bounce'), 1000);
    });

    document.getElementById('modal-'+reqno).addEventListener('click', (e) => {
      if (e.target === document.getElementById('modal-'+reqno)) {
        document.getElementById('modal-'+reqno).classList.add('hidden');
      }
    });
}
make_modal(0);
  
    // Speech-to-text
const microphoneBtn = document.getElementById('microphone-btn');

window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
if(window.SpeechRecognition){
    recognition = new SpeechRecognition("sv-SE");
}
else recognition = {};
//recognition.continuous = true; 
recognition.lang = "sv-SE";

function beep() {
  const audio = new Audio(audiofile); // Very short beep sound
  audio.play();
}

microphoneBtn.addEventListener('click', () => {
  if (recognition.continuous) {
    recognition.continuous = false;
    recognition.stop();
    microphoneBtn.classList.remove('bg-red-500', 'text-white');
    microphoneBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');
    //beep();
  } else {
    recognition.continuous = true;
    recognition.start();
    recognition.continuous = true;
    beep();
    microphoneBtn.classList.add('bg-red-500', 'text-white');
    microphoneBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
  }
});

recognition.onresult = (event) => {
  const transcript = event.results[event.results.length-1][0].transcript;

  if(transcript.replace(/\s/g, "")=="stopstop"){
    recognition.continuous = false;
    recognition.stop();
    microphoneBtn.classList.remove('bg-red-500', 'text-white');
    microphoneBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');
  }
  else messageBox.value += transcript + ' '; 
};

recognition.onend = () => {
  microphoneBtn.classList.remove('bg-red-500', 'text-white');
  microphoneBtn.classList.add('bg-gray-200', 'dark:bg-gray-700');
  recognition.stop();
    recognition.continuous = false;

  beep();
  run_message(document.getElementById('message-box').value);
  document.getElementById('message-box').value="";
  //recognition = new SpeechRecognition();
};
</script>

</body>
</html>
